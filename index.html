<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Log Utility v1.2</title>
    <style>
        /* ğŸŒ‘ åœ°å‘³ãªãƒ“ã‚¸ãƒã‚¹ãƒ»ãƒ„ãƒ¼ãƒ«é¢¨ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰æ›´ */
        body { 
            font-family: -apple-system, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: #f0f2f5; /* ã‚°ãƒ¬ãƒ¼èƒŒæ™¯ */
            color: #333; 
            padding-bottom: 100px; 
            margin: 0; 
        }
        
        /* ğŸ”’ ãƒ­ãƒƒã‚¯ç”»é¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”»é¢é¢¨ï¼‰ */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: 0.5s;
        }
        #lock-screen h1 { margin-bottom: 10px; font-size: 1.5rem; letter-spacing: 2px; }
        #lock-screen p { font-size: 12px; color: #bdc3c7; }
        #lock-screen input {
            padding: 12px; border-radius: 5px; border: 1px solid #34495e; width: 220px;
            font-size: 16px; text-align: center; margin-bottom: 20px; outline: none;
            background: #ecf0f1;
        }
        #lock-screen button {
            padding: 10px 40px; border-radius: 5px; border: none;
            background: #3498db; color: white; font-weight: bold; cursor: pointer; font-size: 14px;
        }

        /* ç”»é¢ä¸Šéƒ¨ */
        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0; width: 100%; }
        .nav-btn { background: #7f8c8d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        h2 { color: #2c3e50; margin: 0; font-size: 1.1rem; }
        
        #calendar { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; 
            max-width: 450px; width: 92%; background: #bdc3c7; padding: 5px; 
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .weekday { text-align: center; font-size: 11px; font-weight: bold; color: #fff; padding: 5px 0; background: #95a5a6; }
        .day { 
            aspect-ratio: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; 
            font-size: 14px; background: #fff; position: relative; min-height: 45px; 
        }
        
        /* åœŸæ—¥ã®è‰²ä»˜ã‘ã¯ç¶­æŒï¼ˆè¨˜éŒ²ã®ã—ã‚„ã™ã•ã®ãŸã‚ï¼‰ */
        .sun { color: #e74c3c; }
        .sat { color: #3498db; }
        .today { background: #ecf0f1 !important; font-weight: bold; text-decoration: underline; }
        .selected { background: #dfe6e9 !important; border: 2px solid #7f8c8d !important; }
        .mark-any { width: 4px; height: 4px; background: #e74c3c; border-radius: 50%; margin-top: 2px; }
        
        /* ç·¨é›†ã‚¨ãƒªã‚¢ */
        #editor-area { 
            display: none; 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 92%; max-width: 400px; background: white; 
            padding: 20px; border-radius: 10px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
            box-sizing: border-box; z-index: 1000;
        }
        #overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 999;
        }
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 55px; height: 55px; background: #2c3e50; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; z-index: 500; border: none;
        }

        label { font-size: 12px; font-weight: bold; color: #7f8c8d; }
        select, textarea { 
            width: 100%; border-radius: 5px; border: 1px solid #bdc3c7; padding: 10px; 
            box-sizing: border-box; font-size: 16px; margin-bottom: 12px;
        }
        textarea { height: 120px; }
        .save-btn { background: #2c3e50; color: white; border: none; padding: 12px; border-radius: 5px; width: 100%; font-size: 16px; cursor: pointer; }
        
        .section-title { width: 92%; max-width: 450px; color: #2c3e50; margin-top: 20px; font-size: 0.9rem; }
        .history-item { 
            background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; 
            border-left: 4px solid #7f8c8d; font-size: 14px;
        }
        .history-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; margin-bottom: 5px; color: #7f8c8d; font-size: 12px; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h1>System Console</h1>
        <p>Access Restricted - Version 1.2.0</p>
        <input type="password" id="pass-input" placeholder="Password">
        <button id="unlock-btn">Login</button>
    </div>

    <div id="overlay"></div>
    <button class="fab" id="fab-btn">ï¼‹</button>

    <div class="calendar-header">
        <button class="nav-btn" id="prev-btn">Prev</button>
        <h2 id="currentMonthYear"></h2>
        <button class="nav-btn" id="next-btn">Next</button>
    </div>
    <div id="calendar"></div>

    <div id="editor-area">
        <h3 id="selected-date-label" style="font-size:1rem; margin-top:0;">Log Entry</h3>
        
        <label>Status (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³)</label>
        <select id="event-input">
            <option value="">--æœªé¸æŠ--</option>
            <option value="å¤–å‡º">ğŸƒ OUT (å¤–å‡º)</option>
            <option value="å¸°å®…">ğŸ  IN (å¸°å®…) </option>
            <option value="ç§»å‹•">ğŸš— Move (ç§»å‹•/è»Šä¸¡)</option>
            <option value="ç‰©å“">ğŸ› Item (ä¸å¯©ãªè·ç‰©)</option>
        </select>

        <label>Category (åˆ†é¡)</label>
        <select id="category-input">
            <option value="">--æœªé¸æŠ--</option>
            <option value="ğŸ“ å ´æ‰€">ğŸ“ Location (å ´æ‰€)</option>
            <option value="ğŸ‘¥ åŒä¼´">ğŸ‘¥ Companion (åŒä¼´è€…)</option>
            <option value="ğŸ’° æ”¯å‡º">ğŸ’° Cost (æ”¯å‡º/ãƒ¬ã‚·ãƒ¼ãƒˆ)</option>
            <option value="ğŸ“ å‚™è€ƒ">ğŸ“ Note (ãã®ä»–)</option>
        </select>

        <textarea id="diary-input" placeholder="ãƒ­ã‚°å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
        <button class="save-btn" id="save-btn">ä¿å­˜ (Update)</button>
    </div>

    <div class="section-title">History Logs</div>
    <div id="history-list" style="width: 92%; max-width: 450px;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ã€é‡è¦ã€‘æ–°ã—ã„Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã«æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼
        const firebaseConfig = {
            apiKey: "AIzaSyD-BUPePOQhznXLV_yPjRnCVVUU2GYvzwM",
            authDomain: "system-log-utility.firebaseapp.com",
            projectId: "system-log-utility",
            storageBucket: "system-log-utility.firebasestorage.app",
            messagingSenderId: "730533909596",
            appId: "1:730533909596:web:aae0a5444253719003c299"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // åˆè¨€è‘‰ï¼ˆãƒãƒ¬ãªã„ã‚‚ã®ã«å¤‰ãˆã¦ãã ã•ã„ï¼‰
        const CORRECT_PASSWORD = "k29%vK&sa%m*3Ix5#9"; 

        document.getElementById('unlock-btn').onclick = () => {
            if (document.getElementById('pass-input').value === CORRECT_PASSWORD) {
                document.getElementById('lock-screen').style.display = "none";
                loadData();
            } else { alert("Login Failed."); }
        };

        let currentViewDate = new Date();
        let selectedDateStr = "";
        let allDiaryData = {};

        function renderCalendarOnly() {
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            document.getElementById('currentMonthYear').innerText = `${year} / ${month + 1}`;
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '<div class="weekday sun">S</div><div class="weekday">M</div><div class="weekday">T</div><div class="weekday">W</div><div class="weekday">T</div><div class="weekday">F</div><div class="weekday sat">S</div>';
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { calendarEl.innerHTML += '<div></div>'; }
            
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.innerText = d;
                const dayOfWeek = new Date(year, month, d).getDay();
                if (dayOfWeek === 0) dayDiv.classList.add('sun');
                if (dayOfWeek === 6) dayDiv.classList.add('sat');
                if (dateStr === selectedDateStr) dayDiv.classList.add('selected');

                if (allDiaryData[dateStr]) {
                    const mark = document.createElement('div');
                    mark.className = 'mark-any';
                    dayDiv.appendChild(mark);
                }
                dayDiv.onclick = () => {
                    selectedDateStr = dateStr;
                    renderCalendarOnly();
                    updateHistoryList();
                };
                calendarEl.appendChild(dayDiv);
            }
        }

        async function loadData() {
            const querySnapshot = await getDocs(collection(db, "logs"));
            allDiaryData = {};
            querySnapshot.forEach(docSnap => { allDiaryData[docSnap.id] = docSnap.data().items || []; });
            renderCalendarOnly();
            updateHistoryList();
        }

        document.getElementById('fab-btn').onclick = () => {
            if (!selectedDateStr) return alert("Select Date first.");
            
            // â˜…è‡ªå‹•ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŒ¿å…¥
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('diary-input').value = `ã€${timeStr}ã€‘ `;
            
            document.getElementById('editor-area').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        };

        document.getElementById('save-btn').onclick = async () => {
            const text = document.getElementById('diary-input').value;
            if(!text) return;
            const docRef = doc(db, "logs", selectedDateStr);
            let items = allDiaryData[selectedDateStr] || [];
            items.push({ 
                text: text, 
                category: document.getElementById('category-input').value, 
                event: document.getElementById('event-input').value 
            });
            await setDoc(docRef, { items: items });
            document.getElementById('editor-area').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            await loadData();
        };

        function updateHistoryList() {
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = "";
            if (!allDiaryData[selectedDateStr]) return;

            allDiaryData[selectedDateStr].forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-header">
                        <span>${item.event || ''} - ${item.category || ''}</span>
                        <div>
                            <button onclick="editItem('${selectedDateStr}', ${idx})" style="background:none; border:none; color:#3498db; cursor:pointer; margin-right:10px;">âœ</button>
                            <button onclick="deleteItem('${selectedDateStr}', ${idx})" style="background:none; border:none; color:#ccc; cursor:pointer;">Ã—</button>
                        </div>
                    </div>
                    <div style="white-space:pre-wrap;">${item.text}</div>`;
                listEl.appendChild(div);
            });
        }

        // ç·¨é›†æ©Ÿèƒ½
        window.editItem = (date, index) => {
            const item = allDiaryData[date][index];
            selectedDateStr = date;
            
            document.getElementById('event-input').value = item.event || "";
            document.getElementById('category-input').value = item.category || "";
            document.getElementById('diary-input').value = item.text;
            
            // ç·¨é›†ä¸­ã®æƒ…å ±ã‚’ä¸€æ™‚ä¿å­˜
            window.editingInfo = { date: date, index: index };
            
            document.getElementById('editor-area').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        };

        // å‰Šé™¤æ©Ÿèƒ½
        window.deleteItem = async (date, index) => {
            if(!confirm("ã“ã®ãƒ­ã‚°ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const docRef = doc(db, "logs", date);
            let items = allDiaryData[date];
            items.splice(index, 1); // æŒ‡å®šã—ãŸç•ªå·ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™
            
            if (items.length === 0) await deleteDoc(docRef);
            else await setDoc(docRef, { items: items });
            
            await loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
        };

        document.getElementById('prev-btn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() - 1); renderCalendarOnly(); };
        document.getElementById('next-btn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() + 1); renderCalendarOnly(); };
        document.getElementById('overlay').onclick = () => { document.getElementById('editor-area').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };

    </script>
</body>
</html>
