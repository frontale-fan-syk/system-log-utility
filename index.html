<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sayaka's Diary</title>
    <style>
        /* å…¨ä½“ãƒ‡ã‚¶ã‚¤ãƒ³ï¼šæ·¡ã„æ°´è‰²ï¼ˆãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã‚‹è‰²ï¼‰ */
        body { 
            font-family: -apple-system, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: #f0f0f2; /* åœ°å‘³ãªã‚°ãƒ¬ãƒ¼ã« */
            color: #444; 
            padding-bottom: 50px; 
            margin: 0; 
        }
        
        /* ğŸ”’ ãƒ­ãƒƒã‚¯ç”»é¢ï¼šé®®ã‚„ã‹ãªãƒ•ãƒ­ãƒ³ã‚¿ãƒ¼ãƒ¬ãƒ–ãƒ«ãƒ¼ */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #00a0e9; /* ãƒ­ãƒƒã‚¯ç”»é¢ï¼šãƒ•ãƒ­ãƒ³ã‚¿ãƒ¼ãƒ¬ã£ã½ã„é®®ã‚„ã‹ãªé’ */
            color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: 0.5s;
        }
        #lock-screen h1 { margin-bottom: 10px; font-size: 2rem; }
        #lock-screen input {
            padding: 15px; border-radius: 10px; border: 2px solid #0078b3; width: 200px;
            font-size: 18px; text-align: center; margin-bottom: 20px; outline: none;
        }
        #lock-screen button {
            padding: 10px 40px; border-radius: 25px; border: 2px solid white;
            background: white; color: #00a0e9; font-weight: bold; cursor: pointer; font-size: 16px;
        }

        /* ã‚¢ãƒ—ãƒªæœ¬ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 15px 0; width: 100%; }
        .nav-btn { background: #0078d4; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; }
        h2 { color: #0078d4; margin: 0; font-size: 1.2rem; text-align: center; }
        
        #calendar { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; 
            max-width: 450px; width: 92%; background: white; padding: 10px; 
            border-radius: 15px; box-shadow: 0 10px 25px rgba(0,100,200,0.1); 
        }
        .weekday { text-align: center; font-size: 12px; font-weight: bold; color: #999; padding: 5px 0; }
        .day { 
            aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; 
            font-size: 14px; border: 1px solid #f0f8ff; background: #fff; position: relative; min-height: 50px; 
        }
        
        /* åœŸæ—¥ã¯é’ã¨èµ¤ */
        .sun, .holiday { color: #ff4d4d !important; background: #fff5f5; }
        .sat { color: #0056b3; background: #f0f4ff; }
        .today { border: 2px solid #00a0e9 !important; font-weight: bold; }
        .selected { background: #ccebff !important; border: 2px solid #0078d4 !important; }
        .mark-any { width: 6px; height: 6px; background: #00a0e9; border-radius: 50%; margin-top: 2px; }
        
        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        #editor-area { 
            margin-top: 20px; width: 92%; max-width: 450px; background: white; 
            padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            box-sizing: border-box; 
        }
        select, textarea { 
            width: 100%; border-radius: 8px; border: 1px solid #cce0ff; padding: 12px; 
            box-sizing: border-box; font-size: 16px; margin-bottom: 15px; background-color: #fcfdff; 
        }
        textarea { height: 100px; resize: none; }
        .save-btn { background: #00a0e9; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; }
        .backup-btn { background: #666; color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; font-size: 14px; cursor: pointer; margin-top: 10px; }
        
        /* æŒ¯ã‚Šè¿”ã‚Šã‚¨ãƒªã‚¢ */
        .section-title { width: 92%; max-width: 450px; color: #0078d4; margin-top: 30px; }
        .filter-group { display: flex; gap: 8px; width: 92%; max-width: 450px; margin-bottom: 15px; }
        .list-container { width: 92%; max-width: 450px; }
        .history-item { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 5px solid #00a0e9; 
            position: relative; 
        }
        .history-header { display: flex; justify-content: space-between; border-bottom: 1px solid #e6f0ff; padding-bottom: 5px; margin-bottom: 8px; font-size: 14px; font-weight: bold; color: #0078d4; }
        .delete-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h1>System Console</h1>
        <p>Unauthorized access is prohibited.</p>
        <input type="password" id="pass-input" placeholder="User Password">
        <button id="unlock-btn">Login</button>
    </div>

    <div class="calendar-header">
        <button class="nav-btn" id="prev-btn">â—€</button>
        <h2 id="currentMonthYear"></h2>
        <button class="nav-btn" id="next-btn">â–¶</button>
    </div>
    <div id="calendar"></div>
    <div id="editor-area">
        <h3 id="selected-date-label">æ—¥ä»˜ã‚’é¸æŠã—ã¦ã­</h3>
        <label>Status (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³)</label>
        <select id="event-input">
            <option value="">--</option>
            <option value="å¤–å‡º">ğŸƒ OUT (å¤–å‡º)</option>
            <option value="å¸°å®…">ğŸ  IN (å¸°å®…)</option>
            <option value="ç§»å‹•">ğŸš— Move (ç§»å‹•/è»Šä¸¡)</option>
            <option value="ç‰©å“">ğŸ› Item (ä¸å¯©ãªè·ç‰©)</option>
        </select>

        <label>Category (åˆ†é¡)</label>
        <select id="category-input">
            <option value="">--</option>
            <option value="ğŸ“ å ´æ‰€">ğŸ“ Location (å ´æ‰€)</option>
            <option value="ğŸ‘¥ åŒä¼´">ğŸ‘¥ Companion (åŒä¼´è€…)</option>
            <option value="ğŸ’° æ”¯å‡º">ğŸ’° Cost (æ”¯å‡º/ãƒ¬ã‚·ãƒ¼ãƒˆ)</option>
            <option value="ğŸ“ å‚™è€ƒ">ğŸ“ Note (ãã®ä»–)</option>
        </select>
        <textarea id="diary-input" placeholder="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"></textarea>
        <button class="save-btn" id="save-btn">åŒæœŸä¿å­˜ã™ã‚‹</button>
        <button class="backup-btn" id="backup-btn">ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)</button>
    </div>
    <div class="section-title"><h3>ğŸ” æŒ¯ã‚Šè¿”ã‚Š</h3></div>
    <div class="filter-group">
        <select id="event-input">
            <option value="none">ãƒ¼ (æŒ‡å®šãªã—)</option>
            <option value="all">ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (æœˆé–“è¡¨ç¤º)</option>
            <option value="å¤–å‡º">ğŸƒ OUT (å¤–å‡º)</option>
            <option value="å¸°å®…">ğŸ  IN (å¸°å®…)</option>
            <option value="ç§»å‹•">ğŸš— Move (ç§»å‹•/è»Šä¸¡)</option>
            <option value="ç‰©å“">ğŸ› Item (ä¸å¯©ãªè·ç‰©)</option>
        </select>
        <select id="category-input">
            <option value="none">ãƒ¼ (æŒ‡å®šãªã—)</option>
            <option value="all">ã™ã¹ã¦ã®æ°—åˆ† (æœˆé–“è¡¨ç¤º)</option>
            <option value="ğŸ“ å ´æ‰€">ğŸ“ Location (å ´æ‰€)</option>
            <option value="ğŸ‘¥ åŒä¼´">ğŸ‘¥ Companion (åŒä¼´è€…)</option>
            <option value="ğŸ’° æ”¯å‡º">ğŸ’° Cost (æ”¯å‡º/ãƒ¬ã‚·ãƒ¼ãƒˆ)</option>
            <option value="ğŸ“ å‚™è€ƒ">ğŸ“ Note (ãã®ä»–)</option>
        </select>
    </div>
    <div id="history-list" class="list-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-BUPePOQhznXLV_yPjRnCVVUU2GYvzwM",
            authDomain: "system-log-utility.firebaseapp.com",
            projectId: "system-log-utility",
            storageBucket: "system-log-utility.firebasestorage.app",
            messagingSenderId: "730533909596",
            appId: "1:730533909596:web:aae0a5444253719003c299"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆã“ã“ã«è‡ªåˆ†ã®å¥½ããªæ–‡å­—ã‚’ï¼ï¼‰
        const CORRECT_PASSWORD = "k29%vK&sa%m*3Ix5#9"; 

        document.getElementById('unlock-btn').onclick = () => {
            const input = document.getElementById('pass-input').value;
            if (input === CORRECT_PASSWORD) {
                document.getElementById('lock-screen').style.opacity = "0";
                setTimeout(() => { document.getElementById('lock-screen').style.display = "none"; }, 500);
                loadData();
            } else { alert("åˆè¨€è‘‰ãŒé•ã†ã¿ãŸã„ã ã‚ˆã€‚"); }
        };

        let currentViewDate = new Date();
        let selectedDateStr = "";
        let allDiaryData = {};
        const holidays2026 = { "01-01":"å…ƒæ—¥", "01-12":"æˆäººã®æ—¥", "02-11":"å»ºå›½è¨˜å¿µã®æ—¥", "02-23":"å¤©çš‡èª•ç”Ÿæ—¥", "03-20":"æ˜¥åˆ†ã®æ—¥", "04-29":"æ˜­å’Œã®æ—¥", "05-03":"æ†²æ³•è¨˜å¿µæ—¥", "05-04":"ã¿ã©ã‚Šã®æ—¥", "05-05":"ã“ã©ã‚‚ã®æ—¥", "05-06":"æŒ¯æ›¿ä¼‘æ—¥", "07-20":"æµ·ã®æ—¥", "08-11":"å±±ã®æ—¥", "09-21":"æ•¬è€ã®æ—¥", "09-22":"å›½æ°‘ã®ä¼‘æ—¥", "09-23":"ç§‹åˆ†ã®æ—¥", "10-12":"ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥", "11-03":"æ–‡åŒ–ã®æ—¥", "11-23":"å‹¤åŠ´æ„Ÿè¬ã®æ—¥" };

        function renderCalendarOnly() {
            const year = currentViewDate.getFullYear();
            const month = currentViewDate.getMonth();
            const monthStr = String(month + 1).padStart(2, '0');
            document.getElementById('currentMonthYear').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '<div class="weekday sun">æ—¥</div><div class="weekday">æœˆ</div><div class="weekday">ç«</div><div class="weekday">æ°´</div><div class="weekday">æœ¨</div><div class="weekday">é‡‘</div><div class="weekday sat">åœŸ</div>';
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { calendarEl.innerHTML += '<div></div>'; }
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${monthStr}-${String(d).padStart(2, '0')}`;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.innerText = d;
                const dayOfWeek = new Date(year, month, d).getDay();
                if (dayOfWeek === 0) dayDiv.classList.add('sun');
                if (dayOfWeek === 6) dayDiv.classList.add('sat');
                if (year === 2026 && holidays2026[dateStr.slice(5)]) dayDiv.classList.add('holiday');
                if (dateStr === selectedDateStr) dayDiv.classList.add('selected');
                if (allDiaryData[dateStr] && allDiaryData[dateStr].length > 0) {
                    const mark = document.createElement('div');
                    mark.className = 'mark-any';
                    dayDiv.appendChild(mark);
                }
                dayDiv.onclick = () => {
                    selectedDateStr = dateStr;
                    document.getElementById('selected-date-label').innerText = `${month + 1}æœˆ ${d}æ—¥ã®è¨˜éŒ²`;

                    // â˜… è¿½åŠ ï¼šæ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸç¬é–“ã«ã€çµã‚Šè¾¼ã¿ã‚’ã€ŒæŒ‡å®šãªã—ã€ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹
                    document.getElementById('filter-event').value = "none";
                    document.getElementById('filter-mood').value = "none";

                    renderCalendarOnly();
                    updateHistoryList();
                };
                calendarEl.appendChild(dayDiv);
            }
        }

        function updateHistoryList() {
            const listEl = document.getElementById('history-list');
            const fEvent = document.getElementById('filter-event').value;
            const fMood = document.getElementById('filter-mood').value;
            listEl.innerHTML = "";

            // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹å¹´ã¨æœˆã‚’å–å¾—
            const year = currentViewDate.getFullYear();
            const monthStr = String(currentViewDate.getMonth() + 1).padStart(2, '0');
            const currentMonthPrefix = `${year}-${monthStr}`;

            // ã€Œãƒ¼ (æŒ‡å®šãªã—)ã€ä»¥å¤–ãŒé¸ã°ã‚Œã¦ã„ã‚Œã°ã€æœˆé–“çµã‚Šè¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã¨ã™ã‚‹
            const isFiltering = (fEvent !== 'none' || fMood !== 'none');

            Object.keys(allDiaryData).sort().reverse().forEach(date => {
                let shouldShow = false;

                if (isFiltering) {
                    // ãƒ«ãƒ¼ãƒ«2ï¼šçµã‚Šè¾¼ã¿ä¸­ã¯ã€Œä»Šé–‹ã„ã¦ã„ã‚‹æœˆã€ã®ã‚‚ã®ã‚’ã™ã¹ã¦å¯¾è±¡ã«ã™ã‚‹
                    shouldShow = date.startsWith(currentMonthPrefix);
                } else {
                    // ãƒ«ãƒ¼ãƒ«1ï¼šä¸¡æ–¹ã€Œãƒ¼ã€ã®æ™‚ã¯ã€Œã‚¯ãƒªãƒƒã‚¯ã—ãŸæ—¥ã€ã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹
                    shouldShow = (date === selectedDateStr);
                }

                if (shouldShow) {
                    allDiaryData[date].forEach((item, idx) => {
                        // "none" ã‚„ "all" ã®å ´åˆã¯åˆ¶é™ã‚’ã‹ã‘ãšã€ãã‚Œä»¥å¤–ã¯ä¸€è‡´ã™ã‚‹ã‚‚ã®ã ã‘æ®‹ã™
                        const matchEvent = (fEvent === 'none' || fEvent === 'all' || item.event === fEvent);
                        const matchMood = (fMood === 'none' || fMood === 'all' || item.category === fMood);

                        if (matchEvent && matchMood) {
                            const div = document.createElement('div');
                            div.className = 'history-item';
                            div.innerHTML = `<div class="history-header"><span>${date} ${item.category || ''} ${item.event ? 'ã€'+item.event+'ã€‘' : ''}</span><button class="delete-btn" onclick="deleteItem('${date}', ${idx})">Ã—</button></div><div style="white-space:pre-wrap;">${item.text}</div>`;
                            listEl.appendChild(div);
                        }
                    });
                }
            });
        }
        async function loadData() {
            const querySnapshot = await getDocs(collection(db, "diaries"));
            allDiaryData = {};
            querySnapshot.forEach(docSnap => { allDiaryData[docSnap.id] = docSnap.data().items || []; });
            renderCalendarOnly();
            updateHistoryList();
        }

        document.getElementById('save-btn').onclick = async () => {
            const text = document.getElementById('diary-input').value;
            if(!selectedDateStr || !text) return alert("æ—¥ä»˜é¸æŠã¨å…¥åŠ›ã‚’ã—ã¦ãã ã•ã„ã­");
            const docRef = doc(db, "diaries", selectedDateStr);
            const snap = await getDoc(docRef);
            let items = snap.exists() ? snap.data().items : [];
            items.push({ text: text, category: document.getElementById('category-input').value, event: document.getElementById('event-input').value });
            await setDoc(docRef, { items: items });
            const now = new Date();
            const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('diary-input').value = `ã€${time}ã€‘ `;
            await loadData();
            alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
        };

        window.deleteItem = async (date, index) => {
            if(!confirm("ã“ã®è¨˜éŒ²ã‚’æ¶ˆã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ")) return;
            const docRef = doc(db, "diaries", date);
            let items = allDiaryData[date];
            items.splice(index, 1);
            if (items.length === 0) await deleteDoc(docRef);
            else await setDoc(docRef, { items: items });
            await loadData();
        };

        document.getElementById('backup-btn').onclick = () => {
            const blob = new Blob([JSON.stringify(allDiaryData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `diary_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        };

        document.getElementById('prev-btn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() - 1); renderCalendarOnly(); };
        document.getElementById('next-btn').onclick = () => { currentViewDate.setMonth(currentViewDate.getMonth() + 1); renderCalendarOnly(); };
        document.getElementById('filter-event').onchange = updateHistoryList;
        document.getElementById('filter-mood').onchange = updateHistoryList;

        renderCalendarOnly();
    </script>
</body>
</html>


